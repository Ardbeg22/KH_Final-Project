<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="adminMapper">
	
	<!-- 매출 통계 관련 resultSet - 작성자 : 장희연  -->
	<resultMap id="salesResultSet" type="sales">
		<result column="TOTAL" property="total" />
		<result column="DATE_RANGE" property="dateRange" />
	</resultMap>

	<!-- 리뷰 관련 resultSet, 작성자: 수빈 -->
	<resultMap id="reviewResultSet" type="review">
		<result column="REVIEW_NO" property="reviewNo" />
		<result column="USER_NO" property="userNo" />
		<result column="MOVIE_ID" property="movieId" />
		<result column="MOVIE_TITLE" property="movieTitle" />
		<result column="TV_ID" property="tvId" />
		<result column="TV_NAME" property="tvName" />
		<result column="REVIEW_STAR" property="reviewStar" />
		<result column="REVIEW_CONTENT" property="reviewContent" />
		<result column="REVIEW_REGISTER_DATE" property="reviewDate" />
		<result column="REVIEW_STATUS" property="reviewStatus" />
		<result column="USER_ID" property="userId" />
		<result column="USER_NICKNAME" property="userNickname" />
	</resultMap>

	<!-- 관리자 한달이용권 월별 매출 - 작성자 : 장희연  -->
	<select id="selectSalesPerMonthOnce" resultMap="salesResultSet">
		SELECT SUM(PAYMENT) "TOTAL"
			 , (TO_CHAR(PAY_DATE,'YYYY.MM')) "DATE_RANGE"
		FROM PAYMENT
		GROUP BY TO_CHAR(PAY_DATE,'YYYY.MM')
		HAVING <![CDATA[ TO_CHAR(PAY_DATE,'YYYY.MM') >= TO_CHAR(ADD_MONTHS(SYSDATE,-11),'YYYY.MM') ]]>
		   AND <![CDATA[ TO_CHAR(PAY_DATE,'YYYY.MM') <= TO_CHAR(SYSDATE,'YYYY.MM') ]]>
		ORDER BY DATE_RANGE
	</select>
	
	<!-- 관리자 월별구독권 월별 매출 - 작성자 : 장희연 -->
	<select id="selectSalesPerMonthSub" resultMap="salesResultSet">
		SELECT SUM(REG_PAYMENT) "TOTAL"
			 , (TO_CHAR(REG_START_DATE,'YYYY.MM')) "DATE_RANGE"
		FROM PAYMENT_REGULAR
		GROUP BY TO_CHAR(REG_START_DATE,'YYYY.MM')
		HAVING <![CDATA[ TO_CHAR(REG_START_DATE,'YYYY.MM') >= TO_CHAR(ADD_MONTHS(SYSDATE,-11),'YYYY.MM') ]]>
		   AND <![CDATA[ TO_CHAR(REG_START_DATE,'YYYY.MM') <= TO_CHAR(SYSDATE,'YYYY.MM') ]]>
		ORDER BY DATE_RANGE
	</select>
	
	<!-- 관리자 월별 매출 - 작성자 : 장희연 -->
	<select id="selectSalesPerMonth" resultMap="salesResultSet">
		SELECT SUM(TOTAL) "TOTAL"
			 , DATE_RANGE
		FROM (
		    SELECT SUM(REG_PAYMENT) "TOTAL"
		         , (TO_CHAR(REG_START_DATE,'YYYY.MM')) "DATE_RANGE"
		    FROM PAYMENT_REGULAR
		    GROUP BY TO_CHAR(REG_START_DATE,'YYYY.MM')
		    HAVING <![CDATA[ TO_CHAR(REG_START_DATE,'YYYY.MM') >= TO_CHAR(ADD_MONTHS(SYSDATE,-11),'YYYY.MM') ]]>
		       AND <![CDATA[ TO_CHAR(REG_START_DATE,'YYYY.MM') <= TO_CHAR(SYSDATE,'YYYY.MM') ]]>
		    UNION
		    SELECT SUM(PAYMENT) "TOTAL"
		         , (TO_CHAR(PAY_DATE,'YYYY.MM')) "DATE_RANGE"
		    FROM PAYMENT
		    GROUP BY TO_CHAR(PAY_DATE,'YYYY.MM')
		    HAVING <![CDATA[ TO_CHAR(PAY_DATE,'YYYY.MM') >= TO_CHAR(ADD_MONTHS(SYSDATE,-11),'YYYY.MM') ]]>
		       AND <![CDATA[ TO_CHAR(PAY_DATE,'YYYY.MM') <= TO_CHAR(SYSDATE,'YYYY.MM') ]]>
		)
		GROUP BY DATE_RANGE
		ORDER BY DATE_RANGE
	</select>
	
	<!-- 관리자 한달이용권 연도별 매출 - 작성자 : 장희연  -->
	<select id="selectSalesPerYearOnce" resultMap="salesResultSet">
		SELECT SUM(PAYMENT) "TOTAL"
			 , (TO_CHAR(PAY_DATE,'YYYY')) "DATE_RANGE"
		FROM PAYMENT
		GROUP BY TO_CHAR(PAY_DATE,'YYYY')
		HAVING <![CDATA[ TO_CHAR(PAY_DATE,'YYYY') >= TO_CHAR(SYSDATE - (INTERVAL '5' YEAR),'YYYY') ]]>
		   AND <![CDATA[ TO_CHAR(PAY_DATE,'YYYY') <= TO_CHAR(SYSDATE,'YYYY') ]]>
		ORDER BY DATE_RANGE
	</select>
	
	<!-- 관리자 월별구독권 연도별 매출 - 작성자 : 장희연 -->
	<select id="selectSalesPerYearSub" resultMap="salesResultSet">
		SELECT SUM(REG_PAYMENT) "TOTAL"
			 , (TO_CHAR(REG_START_DATE,'YYYY')) "DATE_RANGE"
		FROM PAYMENT_REGULAR
		GROUP BY TO_CHAR(REG_START_DATE,'YYYY')
		HAVING <![CDATA[ TO_CHAR(REG_START_DATE,'YYYY') >= TO_CHAR(SYSDATE - (INTERVAL '5' YEAR),'YYYY') ]]>
		   AND <![CDATA[ TO_CHAR(REG_START_DATE,'YYYY') <= TO_CHAR(SYSDATE,'YYYY') ]]> 
		ORDER BY DATE_RANGE
	</select>
	
	<!-- 관리자 연도별 매출 - 작성자 : 장희연 -->
	<select id="selectSalesPerYear" resultMap="salesResultSet">
		SELECT SUM(TOTAL) "TOTAL"
			 , DATE_RANGE
		FROM (
		    SELECT SUM(PAYMENT) "TOTAL"
				 , (TO_CHAR(PAY_DATE,'YYYY')) "DATE_RANGE"
			FROM PAYMENT
			GROUP BY TO_CHAR(PAY_DATE,'YYYY')
			HAVING <![CDATA[ TO_CHAR(PAY_DATE,'YYYY') >= TO_CHAR(SYSDATE - (INTERVAL '5' YEAR),'YYYY') ]]>
			   AND <![CDATA[ TO_CHAR(PAY_DATE,'YYYY') <= TO_CHAR(SYSDATE,'YYYY') ]]>
		    UNION
		    SELECT SUM(REG_PAYMENT) "TOTAL"
				 , (TO_CHAR(REG_START_DATE,'YYYY')) "DATE_RANGE"
			FROM PAYMENT_REGULAR
			GROUP BY TO_CHAR(REG_START_DATE,'YYYY')
			HAVING <![CDATA[ TO_CHAR(REG_START_DATE,'YYYY') >= TO_CHAR(SYSDATE - (INTERVAL '5' YEAR),'YYYY') ]]>
			   AND <![CDATA[ TO_CHAR(REG_START_DATE,'YYYY') <= TO_CHAR(SYSDATE,'YYYY') ]]> 
		)
		GROUP BY DATE_RANGE
		ORDER BY DATE_RANGE
	</select>
	
	<select id="selectViewsTV" parameterType="string" resultType="_int">
		SELECT VIEWS
		FROM TV
		WHERE GENRES LIKE '%' || #{genre} || '%'
	</select>
	
	<select id="selectViewsMovie" parameterType="string" resultType="_int">
		SELECT VIEWS
		FROM MOVIE
		WHERE GENRES LIKE '%' || #{genre} || '%'
	</select>

	<!-- 관리자 페이지 코멘트 관리를 위한 페이징바 , 작성자: 수빈 -->
	<select id="selectAdminCommentListCount" resultType="_int">
		SELECT COUNT(*)
		FROM REVIEW
		WHERE REVIEW_STATUS = 'Y'
	</select>
	
	<!-- 관리자 페이지에서 코멘트 관리를 위해 모든 코멘트 조회 (select) -->
	<select id="selectAdminCommentList" resultMap="reviewResultSet">
		SELECT REVIEW_NO
		     , MB.USER_ID
		     , MB.USER_NICKNAME
		     , MV.TITLE AS "MOVIE_TITLE"
		     , TV.NAME AS "TV_NAME"
		     , TO_CHAR(REVIEW_STAR, 'FM0.0') AS "REVIEW_STAR"
		     , REVIEW_CONTENT
		FROM REVIEW R
		LEFT JOIN MEMBER MB USING(USER_NO)
		LEFT JOIN MOVIE MV ON(R.MOVIE_ID = MV.MOVIE_ID)
		LEFT JOIN TV ON (R.MOVIE_ID = TV.TV_ID)
		WHERE REVIEW_STATUS = 'Y'
		ORDER BY REVIEW_REGISTER_DATE DESC
	</select>
	
	<!-- 관리자 페이지 코멘트 관리에서 검색을 위한 페이징바(select) - 작성자: 수빈 -->
	<select id="searchAdminCommentListCount" resultType="_int">
		SELECT COUNT(*)
		FROM REVIEW R
		LEFT JOIN MEMBER MB USING(USER_NO)
        LEFT JOIN MOVIE MV ON(R.MOVIE_ID = MV.MOVIE_ID)
		LEFT JOIN TV ON (R.MOVIE_ID = TV.TV_ID)
		WHERE  REVIEW_STATUS = 'Y'
		<if test="condition == 'contentsTitle'">
			AND TV.NAME LIKE '%' || #{keyword} || '%'
	        OR MV.TITLE LIKE '%' || #{keyword} || '%'
        </if>
        <if test="condition == 'userId'">
        	AND MB.USER_ID LIKE '%' || #{keyword} || '%'
        </if>
        <if test="condition == 'userNickname'">
        	AND MB.USER_NICKNAME LIKE '%' || #{keyword} || '%'
        </if>
	</select>
	
	<!-- 관리자 페이지 코멘트 관리에서 검색된 코멘트 조회 (select) - 작성자: 수빈 -->
	<select id="searchAdminCommentList" resultMap="reviewResultSet">
		SELECT REVIEW_NO
		     , MB.USER_ID
		     , MB.USER_NICKNAME
		     , MV.TITLE AS "MOVIE_TITLE"
		     , TV.NAME AS "TV_NAME"
		     , TO_CHAR(REVIEW_STAR, 'FM0.0') AS "REVIEW_STAR"
		     , REVIEW_CONTENT
		FROM REVIEW R
		LEFT JOIN MEMBER MB USING(USER_NO)
		LEFT JOIN MOVIE MV ON(R.MOVIE_ID = MV.MOVIE_ID)
		LEFT JOIN TV ON (R.MOVIE_ID = TV.TV_ID)
		WHERE REVIEW_STATUS = 'Y'
		<if test="condition == 'contentsTitle'">
			AND TV.NAME LIKE '%' || #{keyword} || '%'
	        OR MV.TITLE LIKE '%' || #{keyword} || '%'
        </if>
        <if test="condition == 'userId'">
        	AND MB.USER_ID LIKE '%' || #{keyword} || '%'
        </if>
        <if test="condition == 'userNickname'">
        	AND MB.USER_NICKNAME LIKE '%' || #{keyword} || '%'
        </if>
		ORDER BY REVIEW_REGISTER_DATE DESC
	</select>

</mapper>